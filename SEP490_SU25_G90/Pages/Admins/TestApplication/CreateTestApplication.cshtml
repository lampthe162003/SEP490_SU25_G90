@page "/Admins/TestApplication/New"
@model SEP490_SU25_G90.Pages.Admins.TestApplication.CreateTestApplicationModel

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Tạo hồ sơ thi";
}

<div class="mt-4">
    <div>
        <h3 class="text-center font-weight-bold mb-4">Tạo hồ sơ thi</h3>

    </div>
    <div>

        <form method="post" enctype="multipart/form-data">
            <div class="row">
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.CCCD"></label>
                    <div class="input-group">
                        <input asp-for="RequestModel.CCCD" class="form-control" id="cccdInput" />
                        <div class="input-group-append">
                            <button type="button" onclick="searchByCCCD()" class="btn btn-outline-primary">Tìm</button>
                        </div>
                    </div>
                    <span asp-validation-for="RequestModel.CCCD" class="text-danger" id="cccdError"></span>
                    <div id="searchResults" class="mt-2" style="display:none;">
                        <label>Kết quả tìm kiếm:</label>
                        <select class="form-control" id="resultDropdown" onchange="fillInfoFromDropdown(this)">
                            <option value="">-- Chọn --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label>Ngày sinh:</label>
                    <input type="text" class="form-control" readonly id="birthday" />
                </div>
            </div>

            <div class="row mt-2">
                <div class="form-group col-md-6">
                    <label>Họ và tên:</label>
                    <input type="text" class="form-control" readonly id="fullname" />
                </div>
                <div class="form-group col-md-6">
                    <label>Thi bằng:</label>
                    <input type="text" class="form-control" readonly id="licenseType" />
                </div>
            </div>

            <div class="row mt-2">
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.SubmitProfileDate"></label>
                    <input asp-for="RequestModel.SubmitProfileDate" class="form-control" type="date" />
                    <span asp-validation-for="RequestModel.SubmitProfileDate" class="text-danger"></span>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.ExamDate">Ngày thi:</label>
                    <input asp-for="RequestModel.ExamDate" class="form-control" type="date" />
                    <span asp-validation-for="RequestModel.ExamDate" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-2">
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.TheoryScore"></label>
                    <input asp-for="RequestModel.TheoryScore" class="form-control" />
                    <span asp-validation-for="RequestModel.TheoryScore" class="text-danger"></span>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.ObstacleScore"></label>
                    <input asp-for="RequestModel.ObstacleScore" class="form-control" />
                    <span asp-validation-for="RequestModel.ObstacleScore" class="text-danger"></span>
                </div>
            </div>

            <div class="row mt-2">
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.SimulationScore"></label>
                    <input asp-for="RequestModel.SimulationScore" class="form-control" />
                    <span asp-validation-for="RequestModel.SimulationScore" class="text-danger"></span>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.PracticalScore"></label>
                    <input asp-for="RequestModel.PracticalScore" class="form-control" />
                    <span asp-validation-for="RequestModel.PracticalScore" class="text-danger"></span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.Attachment"></label>
                    <input asp-for="RequestModel.Attachment" type="file" class="form-control-file" />
                    <span asp-validation-for="RequestModel.Attachment" class="text-danger"></span>
                </div>
                <div class="form-group col-md-6">
                    <label asp-for="RequestModel.Note"></label>
                    <textarea asp-for="RequestModel.Note" class="form-control" rows="3" placeholder="Ghi chú..."></textarea>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/Admins/TestApplication" class="btn btn-secondary ml-2">Hủy</a>
                <button type="submit" class="btn btn-primary">Tạo mới</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function searchByCCCD() {
            const cccd = document.getElementById("cccdInput").value;
            const errorElem = document.getElementById("cccdError");

            if (!cccd.trim()) {
                errorElem.textContent = "Vui lòng nhập CCCD để tìm.";
                return;
            } else {
                errorElem.textContent = "";

            }
            fetch("/Admins/TestApplication/New?handler=Search", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ cccd: cccd })
            })
            .then(res => res.json())
            .then(data => {
                const dropdown = document.getElementById("resultDropdown");
                dropdown.innerHTML = '<option value="">-- Chọn --</option>';
                data.forEach(item => {
                    const opt = document.createElement("option");
                    opt.value = JSON.stringify(item);
                    opt.textContent = item.text;
                    dropdown.appendChild(opt);
                });
                document.getElementById("searchResults").style.display = "block";
            })
            .catch(err => {
                console.error(err);
                alert("Lỗi tìm kiếm");
            });
        }

        function fillInfoFromDropdown(selectEl) {
            console.log(selectEl.value);
            const selected = selectEl.value;
             let info
            try{
                info = JSON.parse(selected);
            } catch{
                info = {
                    cccd: "",
                    fullname: "",
                    birthday: "",
                    licenseType: ""
                }
            }

            document.getElementById("cccdInput").value = info?.cccd ?? "";
            document.getElementById("fullname").value = info?.fullname ?? "";
            document.getElementById("birthday").value = info?.birthday ?? "";
            document.getElementById("licenseType").value = info?.licenseType ?? "";
        }
    </script>
}
